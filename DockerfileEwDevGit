#FROM debian:stretch-slim
FROM debian:buster-slim
# Authors: Valentino Lauciani and Matteo Quintiliani
LABEL maintainer="Valentino Lauciani <valentino.lauciani@ingv.it>"

ENV DEBIAN_FRONTEND=noninteractive
ENV INITRD No
ENV FAKE_CHROOT 1

ENV EW_INSTALL_INSTALLATION="INST_INGV"
ENV EW_INSTALL_HOME="/opt"
ENV EW_INSTALL_VERSION="earthworm"
ENV EW_INSTALL_BITS=64
ENV EW_RUN_DIR="$EW_INSTALL_HOME/$EW_INSTALL_VERSION"
# https://gitlab.com/seismic-software/earthworm/-/commit/6382013f288ef0f2e40748f7411b792c05c72a66
ENV EW_GIT_REF="6382013f288ef0f2e40748f7411b792c05c72a66"

# Deploy token for ew2openapi repository
ENV DEPLOY_TOKEN="gitlab+deploy-token-1"
ENV DEPLOY_SECRET="9c5vS1x_YsFC4LLHE4sS"

# Deploy token for earthworm/earthworm repository
ENV DEPLOY_TOKEN_EW="gitlab+deploy-token-5"
ENV DEPLOY_SECRET_EW="m_ytooKnNxqgxnPpWyFG"

# Set 'root' pwd
RUN echo root:toor | chpasswd

# Set .bashrc
RUN echo "" >> /root/.bashrc \
     && echo "##################################" >> /root/.bashrc \
     && echo "alias ll='ls -l --color'" >> /root/.bashrc \
     && echo "" >> /root/.bashrc \
     && echo "export LC_ALL=\"C\"" >> /root/.bashrc \
     && echo "" >> /root/.bashrc \
     && echo "export EW_INSTALL_INSTALLATION=\"${EW_INSTALL_INSTALLATION}\"" >> /root/.bashrc \
     && echo "export EW_INSTALL_HOME=\"${EW_INSTALL_HOME}\"" >> /root/.bashrc \
     && echo "export EW_INSTALL_VERSION=\"${EW_INSTALL_VERSION}\"" >> /root/.bashrc \
     && echo "export EW_INSTALL_BITS=${EW_INSTALL_BITS}" >> /root/.bashrc \
     && echo "export EW_RUN_DIR=\"$EW_INSTALL_HOME/$EW_INSTALL_VERSION\"" >> /root/.bashrc \
     && echo "" >> /root/.bashrc

WORKDIR /opt

# Download and install glibc
# install necessary packages
# checkout necessary Earthworm repository directory
# checkout and compile ew2openapi
# remove unnecessary packages
RUN apt-get clean \
		&& apt-get update \
		&& apt-get install -y \
		subversion \
		make \
		gfortran \
		cmake \
		git \
		libcurl4-openssl-dev \
		dh-autoreconf \
		libtirpc-dev \
		autotools-dev \
		pkg-config \
		jq \
                vim \
		&& apt-get clean

# Checkout necessary Earthworm repository directories
RUN echo \
		&& git clone --recursive https://gitlab.com/seismic-software/earthworm.git $EW_INSTALL_HOME/$EW_INSTALL_VERSION \
		&& cd $EW_INSTALL_HOME/$EW_INSTALL_VERSION \
		&& git checkout ${EW_GIT_REF} \
		&& cd - \
		&& cp $EW_INSTALL_HOME/$EW_INSTALL_VERSION/environment/earthworm.d $EW_INSTALL_HOME/$EW_INSTALL_VERSION/environment/earthworm_global.d $EW_INSTALL_HOME/$EW_INSTALL_VERSION/params/ \
		&& cd $EW_INSTALL_HOME/$EW_INSTALL_VERSION/src/libsrc \
		&& bash -c '. $EW_INSTALL_HOME/$EW_INSTALL_VERSION/environment/ew_linux.bash && make -f makefile.unix' \
		&& cd $EW_INSTALL_HOME/$EW_INSTALL_VERSION/src/seismic_processing/hyp2000 \
		&& bash -c '. $EW_INSTALL_HOME/$EW_INSTALL_VERSION/environment/ew_linux.bash && make -f makefile.unix' \
		&& cd $EW_RUN_DIR \
		&& git clone https://${DEPLOY_TOKEN}:${DEPLOY_SECRET}@gitlab.rm.ingv.it/earthworm/ew2openapi.git/ \
		&& cd ew2openapi \
		&& git checkout master \
		&& git submodule deinit -f --all \
		&& git submodule update --init \
		&& bash -c 'sed -e "s/WARNFLAGS=\(.*\)$/# WARNFLAGS=\1\nWARNFLAGS=\"-Wall\"/g" $EW_INSTALL_HOME/$EW_INSTALL_VERSION/environment/ew_linux.bash > $EW_INSTALL_HOME/$EW_INSTALL_VERSION/environment/ew_linux.WARNFLAGS.bash' \
		&& bash -c '. $EW_INSTALL_HOME/$EW_INSTALL_VERSION/environment/ew_linux.WARNFLAGS.bash && make -f makefile.unix static' \
		&& cp $EW_INSTALL_HOME/$EW_INSTALL_VERSION/bin/ew2openapi ./ \
		&& bash -c '. $EW_INSTALL_HOME/$EW_INSTALL_VERSION/environment/ew_linux.bash && mkdir -p $EW_LOG' \
		&& cd $EW_INSTALL_HOME/$EW_INSTALL_VERSION/ \
		&& rm -fr .svn src include lib ew2openapi \
		&& apt-get remove -y \
		subversion \
		make \
		gfortran \
		cmake \
		git \
		libcurl4-openssl-dev \
		dh-autoreconf \
		autotools-dev \
		&& apt-get clean

# Install Go - Used to build shell2http
#RUN curl -O https://dl.google.com/go/go1.20.1.linux-amd64.tar.gz
#RUN rm -rf /usr/local/go && tar -C /usr/local -xzf go1.20.1.linux-amd64.tar.gz
#ENV PATH="$PATH:/usr/local/go/bin"
#RUN rm go1.20.1.linux-amd64.tar.gz

# Install shell2http
#RUN go install github.com/msoap/shell2http@latest
#RUN ln -s $(go env GOPATH)/bin/shell2http /usr/local/bin/shell2http

# Copy file(s)
WORKDIR /opt
COPY entrypoint.sh /opt

# Run Hyp2000
ENTRYPOINT ["bash", "/opt/entrypoint.sh"]
